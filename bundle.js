(()=>{"use strict";window.util={KEY_ENTER:"Enter",KEY_ESCAPE:"Escape",processingRequests:function(e,t,n,o,r){const i=window.data.StatusCode,a=window.data.TIMEOUT,c=new XMLHttpRequest;"GET"===o?c.responseType="json":"POST"===o&&(c.responseType="multipart/form-data"),c.addEventListener("load",(function(){let e;switch(c.status){case i.OK:window.hotels=c.response,window.sortedHotels=c.response,t(window.hotels);break;case i.BAD_REQUEST:e="Неверный запрос";break;case i.UNAUTHORIZED:e="Пользователь не авторизован";break;case i.NOT_FOUND:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+c.status+" "+c.statusText}e&&n(e)})),c.addEventListener("error",(function(){n("Произошла ошибка соединения")})),c.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+c.timeout+"мс")})),c.timeout=a,c.open(o,e),"GET"===o?c.send():"POST"===o&&c.send(r)}},(()=>{const e=document.querySelector(".map"),t=document.querySelector("main");window.data={map:e,main:t,hotelType:{bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},MAPPIN_HEIGHT:70,MAPPIN_WIDTH:50,MAPPIN_CENTER:25,MAX_PINS:5,guestCapacity:{1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},guestValidation:{1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"},priceOfType:{bungalow:0,flat:1e3,house:5e3,palace:1e4},typeOfHouse:"flat",typeOfRoom:"1",MAIN_ARROW_HEIGHT:16,MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,TIMEOUT:1e4,StatusCode:{OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404},PIN_MAIN_X:void 0,PIN_MAIN_Y:void 0}})(),window.backend={getData:function(e,t){window.util.processingRequests("https://21.javascript.pages.academy/keksobooking/data",e,t,"GET")},sendData:function(e,t,n){window.util.processingRequests("https://21.javascript.pages.academy/keksobooking",t,n,"POST",e)}},window.debounce={debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=["gif","jpg","jpeg","png"],t=70,n="Фотография жилья",o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo");function i(t,n){const o=t.target.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}}window.preview={loadAvatarHandler:function(e){i(e,o)},loadPhotosHandler:function(e){const o=document.createElement("img");o.width=t,o.height=t,o.alt=n,r.appendChild(o),i(e,o)},resetPreviews:function(){o.src="img/muffin-grey.svg",r.textContent=""}}})(),(()=>{const e=window.data.map,t=window.data.hotelType,n=window.util.KEY_ENTER,o=window.util.KEY_ESCAPE,r=document.querySelector("#card");window.card={renderCard:function(i){const a=window.sortedHotels[i];let c=r.content.querySelector(".map__card").cloneNode(!0);c.querySelector(".popup__title").textContent=a.offer.title,c.querySelector(".popup__text--address").textContent=a.offer.address,c.querySelector(".popup__text--price").textContent=a.offer.price+" ₽/ночь",c.querySelector(".popup__type").textContent=t[a.offer.type],c.querySelector(".popup__text--capacity").textContent=`${a.offer.rooms} комнаты для ${a.offer.guests} гостей`,c.querySelector(".popup__text--time").textContent=`Заезд после ${a.offer.checkin}, выезд до ${a.offer.checkout}`;const d=c.querySelector(".popup__features");for(;d.firstChild;)d.removeChild(d.firstChild);if(0===a.offer.features.length)d.remove();else for(let e=0;e<a.offer.features.length;e++){let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+a.offer.features[e]),d.appendChild(t)}const s=c.querySelector(".popup__photos");if(0===a.offer.photos.length)s.remove();else{const e=s.querySelector(".popup__photo");let t;s.removeChild(e);for(let n=0;n<a.offer.photos.length;n++)t=e.cloneNode(!0),t.src=a.offer.photos[n],s.appendChild(t)}c.querySelector(".popup__description").textContent=a.offer.description,c.querySelector(".popup__avatar").src=a.author.avatar,c.querySelector(".popup__close").addEventListener("click",(function(e){const t=document.querySelector(".map__pin--active");0!==e.button&&e.key!==n||(c.remove(),t.classList.remove("map__pin--active"))})),document.addEventListener("keydown",(function(e){const t=document.querySelector(".map__pin--active");e.key===o&&(e.preventDefault(),c.remove(),t&&t.classList.remove("map__pin--active"))})),e.appendChild(c)}}})(),(()=>{const e=window.data.MAPPIN_CENTER,t=window.data.MAPPIN_HEIGHT,n=window.data.MAX_PINS,o=window.data.map,r=window.card.renderCard,i=document.querySelector("#pin"),a=document.querySelector(".map__pins");function c(n,o){const r=i.content.cloneNode(!0),a=r.querySelector(".map__pin"),c=a.querySelector("img");return c.src=n.author.avatar,c.alt=n.offer.title,a.style.cssText=`left: ${n.location.x-e}px; top: ${n.location.y-t}px;`,a.dataset.id=o,r}function d(){const e=document.querySelector(".map__pin--active"),t=document.querySelector(".map__card");e&&e.classList.remove("map__pin--active"),t&&t.remove()}o.addEventListener("click",(function(e){e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(d(),r(e.target.dataset.id),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(d(),r(e.target.parentElement.dataset.id),e.target.parentElement.classList.add("map__pin--active"))})),window.pin={renderPins:c,mapPins:a,renderFragmentMapPins:function(e){const t=document.createDocumentFragment();let o=e.length>=n?n:e.length;for(let n=0;n<o;n++)t.appendChild(c(e[n],n));return a.appendChild(t)},removeCard:d}})(),(()=>{const e=window.data.map,t=window.data.main,n=window.util.KEY_ENTER,o=window.util.KEY_ESCAPE,r=window.data.MAIN_ARROW_HEIGHT,i=window.data.MIN_NAME_LENGTH,a=window.data.MAX_NAME_LENGTH;let c=window.data.PIN_MAIN_X,d=window.data.PIN_MAIN_Y;const s=window.pin.renderFragmentMapPins,u=window.data.guestCapacity,l=window.data.guestValidation,p=window.data.priceOfType,f=window.backend.getData,m=window.backend.sendData,w=window.preview.loadAvatarHandler,v=window.preview.loadPhotosHandler,y=window.preview.resetPreviews;let _=window.data.typeOfHouse,E=window.data.typeOfRoom;const g=document.querySelector(".ad-form"),h=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),S=document.querySelector(".map__pin--main"),L=document.querySelector(".ad-form__reset"),q=g.querySelector(".ad-form-header__input"),C=g.querySelector(".ad-form__input"),k=document.querySelector("#success"),A=document.querySelector("#error");function N(){!function(e,t){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","")}(h)}function T(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))}function M(){const e=k.content.cloneNode(!0);document.addEventListener("click",P),document.addEventListener("keydown",x),t.appendChild(e)}function P(e){e.preventDefault();const n=t.querySelector(".success");document.removeEventListener("click",P),document.removeEventListener("keydown",x),t.removeChild(n)}function x(e){e.key===o&&P(e)}function b(){const e=A.content.cloneNode(!0),n=e.querySelector(".error__button");document.addEventListener("click",H),document.addEventListener("keydown",I),n.addEventListener("click",H),t.appendChild(e)}function H(e){e.preventDefault();const n=t.querySelector(".error"),o=n.querySelector(".error__button");document.removeEventListener("click",H),document.removeEventListener("keydown",I),o.removeEventListener("click",H),t.removeChild(n)}function I(e){e.key===o&&H(e)}L.addEventListener("click",(function(){!function(){const e=document.querySelectorAll("form");for(let t=0;t<e.length;t++)e[t].reset()}(),N(),T(),g.classList.add("ad-form--disabled"),e.classList.add("map--faded"),S.style.left=c+"px",S.style.top=d+"px",O(!1),$.placeholder=p.flat;const t=document.querySelector(".map__card");S.addEventListener("click",G),q.removeEventListener("change",w),C.removeEventListener("change",v),y(),t&&t.remove()})),g.addEventListener("submit",(function(e){e.preventDefault(),m(new FormData(g),M,b)}));const D=document.querySelector("#address");function O(e){const t=S.offsetLeft,n=S.offsetTop;c&&d||(c=t,d=n);const o=S.clientWidth,i=S.clientHeight,a=Math.round(t+i/2),s=e?Math.round(n+o+r):Math.round(n+o/2);D.value=`${a}, ${s}`}function R(){!function(e,t){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled","")}(h),g.classList.remove("ad-form--disabled"),e.classList.remove("map--faded"),O(!0),f(s,V),S.removeEventListener("click",G),q.addEventListener("change",w),C.addEventListener("change",v)}function V(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}function G(e){0!==e.button&&e.key!==n||(e.preventDefault(),R())}D.setAttribute("readonly",""),O(!1);const U=0,X=e.offsetWidth,Y=130,W=630;document.querySelector("#title").addEventListener("input",(function(e){const t=e.target.value.length;e.target.validity.valueMissing?e.target.setCustomValidity("Обязательное поле"):t<i?e.target.setCustomValidity(`Ещё ${i-t} симв.`):t>a?e.target.setCustomValidity(`Удалите лишние ${t-a} симв.`):e.target.setCustomValidity(""),e.target.reportValidity()}));const $=document.querySelector("#price"),F=document.querySelector("#type");function K(e){const t=e.value;e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):t<p[_]?e.setCustomValidity("Минимальная цена "+p[_]):t>1e6?e.setCustomValidity("Максимальная цена 1000000"):e.setCustomValidity(""),e.reportValidity()}$.addEventListener("input",(function(e){K(e.target)})),F.addEventListener("change",(function(e){_=e.target.value,$.placeholder=p[e.target.value],K($)}));const j=document.querySelector("#room_number"),z=document.querySelector("#capacity");function B(e){const t=e.value;u[E].some((function(e){return e===t}))?e.setCustomValidity(""):e.setCustomValidity(l[E]),e.reportValidity()}j.addEventListener("change",(function(e){E=e.target.value,B(z)})),z.addEventListener("change",(function(e){B(e.target)}));const Q=document.querySelector("#timein"),Z=document.querySelector("#timeout");Z.addEventListener("change",(function(){Q.value=Z.value})),Q.addEventListener("change",(function(){Z.value=Q.value}));const J=document.querySelector("#avatar"),ee=document.querySelector("#images");J.setAttribute("accept","image/*"),ee.setAttribute("accept","image/*"),window.form={adForm:g,mapPinMain:S,setCoordinates:O,mapPinMainClick:G,mapPinMainMouseDown:function(e){e.preventDefault();let t={x:e.clientX,y:e.clientY},n=!1;function o(e){e.preventDefault(),n=!0;let o=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY},S.style.top=S.offsetTop-i+"px",S.style.left=S.offsetLeft-o+"px",S.offsetLeft<U-S.offsetWidth/2?S.style.left=U-S.offsetWidth/2+"px":S.offsetLeft>X-S.offsetWidth/2&&(S.style.left=X-S.offsetWidth/2+"px"),S.offsetTop<Y-S.offsetHeight-r?S.style.top=Y-S.offsetHeight-r+"px":S.offsetTop>W-S.offsetHeight-r&&(S.style.top=W-S.offsetHeight-r+"px")}document.addEventListener("mousemove",o),document.addEventListener("mouseup",(function e(t){if(t.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",e),O(!0),n){const e=function(t){t.preventDefault(),S.removeEventListener("click",e)};S.addEventListener("click",e)}}))},disableElements:N,inputAddress:D,activatePage:R,removePins:T}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),i=window.data.MAX_PINS,a=window.pin.renderFragmentMapPins,c=window.debounce.debounce(a),d=window.form.removePins,s=window.pin.removeCard,u={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};e.addEventListener("change",(function(){d(),s();const e=window.hotels;c(function(e){return function(e){const t=e.slice(0,i);return window.sortedHotels=t.slice(0,i),t}(e.filter((function(e){return i=e,("any"===t.value||i.offer.type===t.value)&function(e){return"any"===n.value||e.offer.price>=u[n.value].min&&e.offer.price<=u[n.value].max}(e)&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(e)&function(e){return"any"===o.value||e.offer.rooms.toString()===o.value}(e)&function(e){return"any"===r.value||e.offer.guests.toString()===r.value}(e);var i})))}(e))}))})(),(()=>{const e=window.form.mapPinMain,t=window.form.mapPinMainClick,n=window.form.mapPinMainMouseDown,o=window.form.disableElements;e.addEventListener("click",t),e.addEventListener("mousedown",n),o()})()})();