(()=>{"use strict";(()=>{function e(e,t){let n=Math.ceil(e),o=Math.floor(t);return Math.floor(Math.random()*(o-n+1))+n}function t(e){return Math.floor(Math.random()*Math.floor(e))}window.util={KEY_ENTER:"Enter",KEY_ESCAPE:"Escape",getRandomNumber:e,getRandomArr:function(t){let n=e(1,t.length);return t.slice(0,n)},getRandomInt:t,returnsRandomData:function(e){return e[t(e.length)]},processingRequests:function(e,t,n,o,i){const a=window.data.StatusCode,r=window.data.TIMEOUT,c=new XMLHttpRequest;c.responseType="json",c.addEventListener("load",(function(){let e;switch(c.status){case a.OK:window.hotels=c.response,window.sortedHotels=c.response,t(window.hotels);break;case a.BadRequest:e="Неверный запрос";break;case a.Unauthorized:e="Пользователь не авторизован";break;case a.NotFound:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+c.status+" "+c.statusText}e&&n(e)})),c.addEventListener("error",(function(){n("Произошла ошибка соединения")})),c.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+c.timeout+"мс")})),c.timeout=r,c.open(o,e),c.send(i)}}})(),(()=>{const e=document.querySelector(".map"),t=e.offsetWidth,n=window.util.getRandomNumber,o=document.querySelector("main"),i=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),a=document.createDocumentFragment();a.appendChild(i),o.appendChild(a),i.classList.add("hidden");const r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);a.appendChild(r),o.appendChild(a),r.classList.add("hidden"),window.data={map:e,MAPPIN_HEIGHT:70,MAPPIN_WIDTH:50,MAPPIN_CENTER:25,MAX_PINS:5,guestCapacity:{1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},guestValidation:{1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"},priceOfType:{bungalow:0,flat:1e3,house:5e3,palace:1e4},typeOfHouse:"flat",typeOfRoom:"1",MAIN_ARROW_HEIGHT:16,MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,getCoordinateX:function(){return n(50,t-50)},getCoordinateY:function(){return n(130,630)},blockMain:o,popUpSuccess:i,popUpError:r,TIMEOUT:1e4,StatusCode:{OK:200,BadRequest:400,Unauthorized:401,NotFound:404},PIN_MAIN_X:void 0,PIN_MAIN_Y:void 0}})(),window.backend={getData:function(e,t,n){window.util.processingRequests(e,t,n,"GET")},sendData:function(e,t,n){window.util.processingRequests("https://21.javascript.pages.academy/keksobooking",t,n,"POST",e)}},window.debounce={debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=window.data.map,t=window.util.KEY_ENTER,n=window.util.KEY_ESCAPE,o=document.querySelector("#card");window.card={renderCard:function(i){const a=window.sortedHotels[i];let r=o.content.querySelector(".map__card").cloneNode(!0);r.querySelector(".popup__title").textContent=a.offer.title,r.querySelector(".popup__text--address").textContent=a.offer.address,r.querySelector(".popup__text--price").textContent=a.offer.price+" ₽/ночь",r.querySelector(".popup__type").textContent=a.offer.type,r.querySelector(".popup__text--capacity").textContent=`${a.offer.rooms} комнаты для ${a.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${a.offer.checkin}, выезд до ${a.offer.checkout}`;const c=r.querySelector(".popup__features");for(;c.firstChild;)c.removeChild(c.firstChild);for(let e=0;e<a.offer.features.length;e++){let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+a.offer.features[e]),c.appendChild(t)}r.querySelector(".popup__description").textContent=a.offer.description;const d=r.querySelector(".popup__photos"),s=d.querySelector(".popup__photo");let u;d.removeChild(s);for(let e=0;e<a.offer.photos.length;e++)u=s.cloneNode(!0),u.src=a.offer.photos[e],d.appendChild(u);r.querySelector(".popup__avatar").src=a.author.avatar,r.querySelector(".popup__close").addEventListener("click",(function(e){const n=document.querySelector(".map__pin--active");0!==e.button&&e.key!==t||(r.remove(),n.classList.remove("map__pin--active"))})),document.addEventListener("keydown",(function(e){const t=document.querySelector(".map__pin--active");e.key===n&&(e.preventDefault(),r.remove(),t&&t.classList.remove("map__pin--active"))})),e.appendChild(r)}}})(),(()=>{const e=window.data.MAPPIN_CENTER,t=window.data.MAPPIN_HEIGHT,n=window.data.MAX_PINS,o=window.data.map,i=window.card.renderCard,a=document.querySelector("#pin"),r=document.querySelector(".map__pins");function c(n,o){const i=a.content.cloneNode(!0),r=i.querySelector(".map__pin"),c=r.querySelector("img");return c.src=n.author.avatar,c.alt=n.offer.title,r.style.cssText=`left: ${n.location.x-e}px; top: ${n.location.y-t}px;`,r.dataset.id=o,i}function d(){const e=document.querySelector(".map__pin--active"),t=document.querySelector(".map__card");e&&e.classList.remove("map__pin--active"),t&&t.remove()}o.addEventListener("click",(function(e){e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(d(),i(e.target.dataset.id),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(d(),i(e.target.parentElement.dataset.id),e.target.parentElement.classList.add("map__pin--active"))})),window.pin={renderPins:c,mapPins:r,renderFragmentMapPins:function(e){const t=document.createDocumentFragment();let o=e.length>=n?n:e.length;for(let n=0;n<o;n++)t.appendChild(c(e[n],n));return r.appendChild(t)},removeCard:d}})(),(()=>{const e=window.data.map,t=window.util.KEY_ENTER,n=window.util.KEY_ESCAPE,o=window.pin.renderFragmentMapPins,i=window.data.guestCapacity,a=window.data.guestValidation,r=window.data.priceOfType;let c=window.data.typeOfHouse,d=window.data.typeOfRoom;const s=window.data.MAIN_ARROW_HEIGHT,u=window.data.MIN_NAME_LENGTH,l=window.data.MAX_NAME_LENGTH,p=window.backend.getData,f=window.backend.sendData,m=window.data.popUpError,w=window.data.popUpSuccess;let y=window.data.PIN_MAIN_X,_=window.data.PIN_MAIN_Y;const v=document.querySelector(".ad-form"),g=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),h=document.querySelector(".map__pin--main"),E=document.querySelector(".ad-form__reset"),S=function(){!function(e,t){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","")}(g)};function L(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))}function q(){!function(){const e=document.querySelectorAll("form");for(let t=0;t<e.length;t++)e[t].reset()}(),S(),L(),v.classList.add("ad-form--disabled"),e.classList.add("map--faded"),h.style.left=y+"px",h.style.top=_+"px",k(!1);const t=document.querySelector(".map__card");h.addEventListener("click",T),h.removeEventListener("mousedown",V),t&&t.remove()}function C(){q(),N(w)}function M(){N(m),m.querySelector(".error__button").addEventListener("click",b)}function N(e){e.classList.remove("hidden")}function b(){m.classList.contains("hidden")?w.classList.contains("hidden")||w.classList.add("hidden"):m.classList.add("hidden")}E.addEventListener("click",q),v.addEventListener("submit",(function(e){e.preventDefault(),f(new FormData(v),C,M),document.addEventListener("keydown",(function(e){e.key===n&&(e.preventDefault(),b())})),document.addEventListener("click",b)}));const A=document.querySelector("#address");function k(e){const t=h.offsetLeft,n=h.offsetTop;y&&_||(y=t,_=n);const o=h.clientWidth,i=h.clientHeight,a=Math.round(t+i/2),r=e?Math.round(n+o+s):Math.round(n+o/2);A.value=`${a}, ${r}`}A.setAttribute("readonly",""),k(!1);const x=function(){!function(e,t){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled","")}(g),v.classList.remove("ad-form--disabled"),e.classList.remove("map--faded"),k(!0),p("https://21.javascript.pages.academy/keksobooking/data",o,P),h.addEventListener("mousedown",V),h.removeEventListener("click",T)},P=function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};function T(e){0!==e.button&&e.key!==t||(e.preventDefault(),x())}const I=0,H=e.offsetWidth,R=130,D=630;function V(e){e.preventDefault();let t={x:e.clientX,y:e.clientY},n=!1;const o=function(e){e.preventDefault(),n=!0;let o=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY},h.style.top=h.offsetTop-i+"px",h.style.left=h.offsetLeft-o+"px",h.offsetLeft<I-h.offsetWidth/2?h.style.left=I-h.offsetWidth/2+"px":h.offsetLeft>H-h.offsetWidth/2&&(h.style.left=H-h.offsetWidth/2+"px"),h.offsetTop<R-h.offsetHeight-s?h.style.top=R-h.offsetHeight-s+"px":h.offsetTop>D-h.offsetHeight-s&&(h.style.top=D-h.offsetHeight-s+"px")},i=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i),k(!0),n){const e=function(t){t.preventDefault(),h.removeEventListener("click",e)};h.addEventListener("click",e)}};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}document.querySelector("#title").addEventListener("input",(function(e){const t=e.target.value.length;e.target.validity.valueMissing?e.target.setCustomValidity("Обязательное поле"):t<u?e.target.setCustomValidity(`Ещё ${u-t} симв.`):t>l?e.target.setCustomValidity(`Удалите лишние ${t-l} симв.`):e.target.setCustomValidity(""),e.target.reportValidity()}));const O=document.querySelector("#price"),X=document.querySelector("#type");let Y=function(e){const t=e.value;e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):t<r[c]?e.setCustomValidity("Минимальная цена "+r[c]):t>1e6?e.setCustomValidity("Максимальная цена 1000000"):e.setCustomValidity(""),e.reportValidity()};O.addEventListener("input",(function(e){Y(e.target)})),X.addEventListener("change",(function(e){c=e.target.value,O.placeholder=r[e.target.value],Y(O)}));const W=document.querySelector("#room_number"),$=document.querySelector("#capacity"),F=function(e){const t=e.value;i[d].some((function(e){return e===t}))?e.setCustomValidity(""):e.setCustomValidity(a[d]),e.reportValidity()};W.addEventListener("change",(function(e){d=e.target.value,F($)})),$.addEventListener("change",(function(e){F(e.target)}));const G=document.querySelector("#timein"),K=document.querySelector("#timeout");K.addEventListener("change",(function(){G.value=K.value})),G.addEventListener("change",(function(){K.value=G.value}));const U=document.querySelector("#avatar"),j=document.querySelector("#images");U.setAttribute("accept","image/*"),j.setAttribute("accept","image/*"),window.form={adForm:v,mapPinMain:h,setCoordinates:k,mapPinMainClick:T,disableElements:S,inputAddress:A,activatePage:x,removePins:L}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),a=window.data.MAX_PINS,r=window.pin.renderFragmentMapPins,c=window.debounce.debounce(r),d=window.form.removePins,s=window.pin.removeCard,u={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};e.addEventListener("change",(function(){d(),s();const e=window.hotels;c(l(e))}));const l=function(e){return function(e){const t=e.slice(0,a);return window.sortedHotels=t.slice(0,a),t}(e.filter((function(e){return a=e,("any"===t.value||a.offer.type===t.value)&function(e){return"any"===n.value||e.offer.price>=u[n.value].min&&e.offer.price<=u[n.value].max}(e)&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(e)&function(e){return"any"===o.value||e.offer.rooms.toString()===o.value}(e)&function(e){return"any"===i.value||e.offer.guests.toString()===i.value}(e);var a})))}})(),(()=>{const e=window.form.mapPinMain,t=window.form.mapPinMainClick,n=window.form.disableElements;e.addEventListener("click",t),n()})()})();