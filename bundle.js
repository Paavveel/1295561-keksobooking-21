(()=>{"use strict";(()=>{function e(e,t){let n=Math.ceil(e),o=Math.floor(t);return Math.floor(Math.random()*(o-n+1))+n}function t(e){return Math.floor(Math.random()*Math.floor(e))}window.util={KEY_ENTER:"Enter",KEY_ESCAPE:"Escape",getRandomNumber:e,getRandomArr:function(t){let n=e(1,t.length);return t.slice(0,n)},getRandomInt:t,returnsRandomData:function(e){return e[t(e.length)]},processingRequests:function(e,t,n,o,r){const i=window.data.StatusCode,a=window.data.TIMEOUT,d=new XMLHttpRequest;d.responseType="json",d.addEventListener("load",(function(){let e;switch(d.status){case i.OK:window.hotels=d.response,window.sortedHotels=d.response,t(window.hotels);break;case i.BAD_REQUEST:e="Неверный запрос";break;case i.UNAUTHORIZED:e="Пользователь не авторизован";break;case i.NOT_FOUND:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+d.status+" "+d.statusText}e&&n(e)})),d.addEventListener("error",(function(){n("Произошла ошибка соединения")})),d.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+d.timeout+"мс")})),d.timeout=a,d.open(o,e),d.send(r)}}})(),(()=>{const e=document.querySelector(".map"),t=e.offsetWidth,n=window.util.getRandomNumber,o=document.querySelector("main"),r=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),i=document.createDocumentFragment();i.appendChild(r),o.appendChild(i),r.classList.add("hidden");const a=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);i.appendChild(a),o.appendChild(i),a.classList.add("hidden"),window.data={map:e,MAPPIN_HEIGHT:70,MAPPIN_WIDTH:50,MAPPIN_CENTER:25,MAX_PINS:5,guestCapacity:{1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},guestValidation:{1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"},priceOfType:{bungalow:0,flat:1e3,house:5e3,palace:1e4},typeOfHouse:"flat",typeOfRoom:"1",MAIN_ARROW_HEIGHT:16,MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,getCoordinateX:function(){return n(50,t-50)},getCoordinateY:function(){return n(130,630)},blockMain:o,popUpSuccess:r,popUpError:a,TIMEOUT:1e4,StatusCode:{OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404},PIN_MAIN_X:void 0,PIN_MAIN_Y:void 0}})(),window.backend={getData:function(e,t,n){window.util.processingRequests(e,t,n,"GET")},sendData:function(e,t,n){window.util.processingRequests("https://21.javascript.pages.academy/keksobooking",t,n,"POST",e)}},window.debounce={debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=["gif","jpg","jpeg","png"],t=70,n="Фотография жилья",o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo");function i(t,n){const o=t.target.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}}window.preview={loadAvatarHandler:function(e){i(e,o)},loadPhotosHandler:function(e){const o=document.createElement("img");o.width=t,o.height=t,o.alt=n,r.appendChild(o),i(e,o)},resetPreviews:function(){o.src="img/muffin-grey.svg",r.textContent=""}}})(),(()=>{const e=window.data.map,t=window.util.KEY_ENTER,n=window.util.KEY_ESCAPE,o=document.querySelector("#card");window.card={renderCard:function(r){const i=window.sortedHotels[r];let a=o.content.querySelector(".map__card").cloneNode(!0);a.querySelector(".popup__title").textContent=i.offer.title,a.querySelector(".popup__text--address").textContent=i.offer.address,a.querySelector(".popup__text--price").textContent=i.offer.price+" ₽/ночь",a.querySelector(".popup__type").textContent=i.offer.type,a.querySelector(".popup__text--capacity").textContent=`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`,a.querySelector(".popup__text--time").textContent=`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`;const d=a.querySelector(".popup__features");for(;d.firstChild;)d.removeChild(d.firstChild);for(let e=0;e<i.offer.features.length;e++){let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+i.offer.features[e]),d.appendChild(t)}a.querySelector(".popup__description").textContent=i.offer.description;const c=a.querySelector(".popup__photos"),s=c.querySelector(".popup__photo");let u;c.removeChild(s);for(let e=0;e<i.offer.photos.length;e++)u=s.cloneNode(!0),u.src=i.offer.photos[e],c.appendChild(u);a.querySelector(".popup__avatar").src=i.author.avatar,a.querySelector(".popup__close").addEventListener("click",(function(e){const n=document.querySelector(".map__pin--active");0!==e.button&&e.key!==t||(a.remove(),n.classList.remove("map__pin--active"))})),document.addEventListener("keydown",(function(e){const t=document.querySelector(".map__pin--active");e.key===n&&(e.preventDefault(),a.remove(),t&&t.classList.remove("map__pin--active"))})),e.appendChild(a)}}})(),(()=>{const e=window.data.MAPPIN_CENTER,t=window.data.MAPPIN_HEIGHT,n=window.data.MAX_PINS,o=window.data.map,r=window.card.renderCard,i=document.querySelector("#pin"),a=document.querySelector(".map__pins");function d(n,o){const r=i.content.cloneNode(!0),a=r.querySelector(".map__pin"),d=a.querySelector("img");return d.src=n.author.avatar,d.alt=n.offer.title,a.style.cssText=`left: ${n.location.x-e}px; top: ${n.location.y-t}px;`,a.dataset.id=o,r}function c(){const e=document.querySelector(".map__pin--active"),t=document.querySelector(".map__card");e&&e.classList.remove("map__pin--active"),t&&t.remove()}o.addEventListener("click",(function(e){e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(c(),r(e.target.dataset.id),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(c(),r(e.target.parentElement.dataset.id),e.target.parentElement.classList.add("map__pin--active"))})),window.pin={renderPins:d,mapPins:a,renderFragmentMapPins:function(e){const t=document.createDocumentFragment();let o=e.length>=n?n:e.length;for(let n=0;n<o;n++)t.appendChild(d(e[n],n));return a.appendChild(t)},removeCard:c}})(),(()=>{const e=window.data.map,t=window.util.KEY_ENTER,n=window.util.KEY_ESCAPE,o=window.data.MAIN_ARROW_HEIGHT,r=window.data.MIN_NAME_LENGTH,i=window.data.MAX_NAME_LENGTH;let a=window.data.PIN_MAIN_X,d=window.data.PIN_MAIN_Y;const c=window.pin.renderFragmentMapPins,s=window.data.guestCapacity,u=window.data.guestValidation,l=window.data.priceOfType,p=window.backend.getData,f=window.backend.sendData,m=window.data.popUpError,w=window.data.popUpSuccess,_=window.preview.loadAvatarHandler,v=window.preview.loadPhotosHandler,y=window.preview.resetPreviews;let g=window.data.typeOfHouse,h=window.data.typeOfRoom;const E=document.querySelector(".ad-form"),S=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),L=document.querySelector(".map__pin--main"),q=document.querySelector(".ad-form__reset"),C=E.querySelector(".ad-form-header__input"),N=E.querySelector(".ad-form__input");function A(){!function(e,t){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","")}(S)}function M(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))}function b(){!function(){const e=document.querySelectorAll("form");for(let t=0;t<e.length;t++)e[t].reset()}(),A(),M(),E.classList.add("ad-form--disabled"),e.classList.add("map--faded"),L.style.left=a+"px",L.style.top=d+"px",I(!1);const t=document.querySelector(".map__card");L.addEventListener("click",O),L.removeEventListener("mousedown",W),C.removeEventListener("change",_),N.removeEventListener("change",v),y(),t&&t.remove()}function x(){b(),P(w)}function k(){P(m),m.querySelector(".error__button").addEventListener("click",T)}function P(e){e.classList.remove("hidden")}function T(){m.classList.contains("hidden")?w.classList.contains("hidden")||w.classList.add("hidden"):m.classList.add("hidden")}q.addEventListener("click",b),E.addEventListener("submit",(function(e){e.preventDefault(),f(new FormData(E),x,k),document.addEventListener("keydown",(function(e){e.key===n&&(e.preventDefault(),T())})),document.addEventListener("click",T)}));const H=document.querySelector("#address");function I(e){const t=L.offsetLeft,n=L.offsetTop;a&&d||(a=t,d=n);const r=L.clientWidth,i=L.clientHeight,c=Math.round(t+i/2),s=e?Math.round(n+r+o):Math.round(n+r/2);H.value=`${c}, ${s}`}function R(){!function(e,t){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled","")}(S),E.classList.remove("ad-form--disabled"),e.classList.remove("map--faded"),I(!0),p("https://21.javascript.pages.academy/keksobooking/data",c,D),L.addEventListener("mousedown",W),L.removeEventListener("click",O),C.addEventListener("change",_),N.addEventListener("change",v)}function D(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}function O(e){0!==e.button&&e.key!==t||(e.preventDefault(),R())}H.setAttribute("readonly",""),I(!1);const U=0,V=e.offsetWidth,X=130,Y=630;function W(e){e.preventDefault();let t={x:e.clientX,y:e.clientY},n=!1;function r(e){e.preventDefault(),n=!0;let r=t.x-e.clientX,i=t.y-e.clientY;t={x:e.clientX,y:e.clientY},L.style.top=L.offsetTop-i+"px",L.style.left=L.offsetLeft-r+"px",L.offsetLeft<U-L.offsetWidth/2?L.style.left=U-L.offsetWidth/2+"px":L.offsetLeft>V-L.offsetWidth/2&&(L.style.left=V-L.offsetWidth/2+"px"),L.offsetTop<X-L.offsetHeight-o?L.style.top=X-L.offsetHeight-o+"px":L.offsetTop>Y-L.offsetHeight-o&&(L.style.top=Y-L.offsetHeight-o+"px")}document.addEventListener("mousemove",r),document.addEventListener("mouseup",(function e(t){if(t.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",e),I(!0),n){const e=function(t){t.preventDefault(),L.removeEventListener("click",e)};L.addEventListener("click",e)}}))}document.querySelector("#title").addEventListener("input",(function(e){const t=e.target.value.length;e.target.validity.valueMissing?e.target.setCustomValidity("Обязательное поле"):t<r?e.target.setCustomValidity(`Ещё ${r-t} симв.`):t>i?e.target.setCustomValidity(`Удалите лишние ${t-i} симв.`):e.target.setCustomValidity(""),e.target.reportValidity()}));const F=document.querySelector("#price"),$=document.querySelector("#type");function G(e){const t=e.value;e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):t<l[g]?e.setCustomValidity("Минимальная цена "+l[g]):t>1e6?e.setCustomValidity("Максимальная цена 1000000"):e.setCustomValidity(""),e.reportValidity()}F.addEventListener("input",(function(e){G(e.target)})),$.addEventListener("change",(function(e){g=e.target.value,F.placeholder=l[e.target.value],G(F)}));const K=document.querySelector("#room_number"),j=document.querySelector("#capacity");function z(e){const t=e.value;s[h].some((function(e){return e===t}))?e.setCustomValidity(""):e.setCustomValidity(u[h]),e.reportValidity()}K.addEventListener("change",(function(e){h=e.target.value,z(j)})),j.addEventListener("change",(function(e){z(e.target)}));const B=document.querySelector("#timein"),Q=document.querySelector("#timeout");Q.addEventListener("change",(function(){B.value=Q.value})),B.addEventListener("change",(function(){Q.value=B.value}));const Z=document.querySelector("#avatar"),J=document.querySelector("#images");Z.setAttribute("accept","image/*"),J.setAttribute("accept","image/*"),window.form={adForm:E,mapPinMain:L,setCoordinates:I,mapPinMainClick:O,disableElements:A,inputAddress:H,activatePage:R,removePins:M}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),i=window.data.MAX_PINS,a=window.pin.renderFragmentMapPins,d=window.debounce.debounce(a),c=window.form.removePins,s=window.pin.removeCard,u={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};e.addEventListener("change",(function(){c(),s();const e=window.hotels;d(function(e){return function(e){const t=e.slice(0,i);return window.sortedHotels=t.slice(0,i),t}(e.filter((function(e){return i=e,("any"===t.value||i.offer.type===t.value)&function(e){return"any"===n.value||e.offer.price>=u[n.value].min&&e.offer.price<=u[n.value].max}(e)&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(e)&function(e){return"any"===o.value||e.offer.rooms.toString()===o.value}(e)&function(e){return"any"===r.value||e.offer.guests.toString()===r.value}(e);var i})))}(e))}))})(),(()=>{const e=window.form.mapPinMain,t=window.form.mapPinMainClick,n=window.form.disableElements;e.addEventListener("click",t),n()})()})();