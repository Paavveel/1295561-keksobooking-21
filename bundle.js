(()=>{"use strict";window.util={KEY_ENTER:"Enter",KEY_ESCAPE:"Escape",processingRequests:(e,t,o,n,a)=>{const r=window.data.StatusCode,i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case r.OK:window.hotels=i.response,window.sortedHotels=i.response,t(window.hotels);break;case r.BAD_REQUEST:e="Неверный запрос";break;case r.UNAUTHORIZED:e="Пользователь не авторизован";break;case r.NOT_FOUND:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+i.status+" "+i.statusText}e&&o(e)})),i.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=1e4,i.open(n,e),"GET"===n?i.send():"POST"===n&&i.send(a)}},(()=>{const e=document.querySelector(".map"),t=document.querySelector("main");window.data={map:e,main:t,hotelType:{bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},MAPPIN_HEIGHT:70,MAPPIN_WIDTH:50,MAPPIN_CENTER:25,MAX_PINS:5,guestCapacity:{1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},guestValidation:{1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"},priceOfType:{bungalow:0,flat:1e3,house:5e3,palace:1e4},typeOfHouse:"flat",typeOfRoom:"1",MAIN_ARROW_HEIGHT:16,MIN_NAME_LENGTH:30,MAX_NAME_LENGTH:100,StatusCode:{OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404},pinMainX:void 0,pinMainY:void 0}})(),window.backend={getData:(e,t)=>{window.util.processingRequests("https://21.javascript.pages.academy/keksobooking/data",e,t,"GET")},sendData:(e,t,o)=>{window.util.processingRequests("https://21.javascript.pages.academy/keksobooking",t,o,"POST",e)}},window.helpers={debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=["gif","jpg","jpeg","png"],t=70,o="Фотография жилья",n=document.querySelector(".ad-form-header__preview img"),a=document.querySelector(".ad-form__photo"),r=(t,o)=>{const n=t.target.files[0],a=n.name.toLowerCase();if(e.some((e=>a.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}};window.preview={onAvatarLoad:e=>{r(e,n)},onPhotosLoad:e=>{const n=document.createElement("img");n.width=t,n.height=t,n.alt=o,a.appendChild(n),r(e,n)},resetPreviews:()=>{n.src="img/muffin-grey.svg",a.textContent=""}}})(),(()=>{const e=window.util.KEY_ENTER,t=window.util.KEY_ESCAPE,o=window.data.map,n=window.data.hotelType,a=document.querySelector("#card");window.popup={renderCard:r=>{const i=window.sortedHotels[r];let d=a.content.querySelector(".map__card").cloneNode(!0);d.querySelector(".popup__title").textContent=i.offer.title,d.querySelector(".popup__text--address").textContent=i.offer.address,d.querySelector(".popup__text--price").textContent=i.offer.price+" ₽/ночь",d.querySelector(".popup__type").textContent=n[i.offer.type],d.querySelector(".popup__text--capacity").textContent=`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`,d.querySelector(".popup__text--time").textContent=`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`;const s=d.querySelector(".popup__features");for(;s.firstChild;)s.removeChild(s.firstChild);0===i.offer.features.length?s.remove():i.offer.features.forEach((e=>{let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),s.appendChild(t)}));const c=d.querySelector(".popup__photos");if(0===i.offer.photos.length)c.remove();else{const e=c.querySelector(".popup__photo");let t;c.removeChild(e),i.offer.photos.forEach((o=>{t=e.cloneNode(!0),t.src=o,c.appendChild(t)}))}d.querySelector(".popup__description").textContent=i.offer.description,d.querySelector(".popup__avatar").src=i.author.avatar,d.querySelector(".popup__close").addEventListener("click",(t=>{const o=document.querySelector(".map__pin--active");0!==t.button&&t.key!==e||(d.remove(),o.classList.remove("map__pin--active"))})),document.addEventListener("keydown",(e=>{const o=document.querySelector(".map__pin--active");e.key===t&&(e.preventDefault(),d.remove(),o&&o.classList.remove("map__pin--active"))})),o.appendChild(d)}}})(),(()=>{const e=window.data.MAPPIN_CENTER,t=window.data.MAPPIN_HEIGHT,o=window.data.MAX_PINS,n=window.data.map,a=window.popup.renderCard,r=document.querySelector("#pin"),i=document.querySelector(".map__pins"),d=(o,n)=>{const a=r.content.cloneNode(!0),i=a.querySelector(".map__pin"),d=i.querySelector("img");return d.src=o.author.avatar,d.alt=o.offer.title,i.style.cssText=`left: ${o.location.x-e}px; top: ${o.location.y-t}px;`,i.dataset.id=n,a},s=()=>{const e=document.querySelector(".map__pin--active"),t=document.querySelector(".map__card");e&&e.classList.remove("map__pin--active"),t&&t.remove()};n.addEventListener("click",(e=>{e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(s(),a(e.target.dataset.id),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(s(),a(e.target.parentElement.dataset.id),e.target.parentElement.classList.add("map__pin--active"))})),window.pin={renderPins:d,mapPins:i,renderFragmentMapPins:e=>{const t=document.createDocumentFragment();return e.slice(0,o).forEach(((e,o)=>{t.appendChild(d(e,o))})),i.appendChild(t)},removeCard:s}})(),(()=>{const e=window.util.KEY_ENTER,t=window.util.KEY_ESCAPE,o=window.data.MAIN_ARROW_HEIGHT,n=window.data.MIN_NAME_LENGTH,a=window.data.MAX_NAME_LENGTH,r=window.data.map,i=window.data.main,d=window.pin.renderFragmentMapPins,s=window.data.guestCapacity,c=window.data.guestValidation,l=window.data.priceOfType,u=window.backend.getData,p=window.backend.sendData,m=window.preview.onAvatarLoad,f=window.preview.onPhotosLoad,v=window.preview.resetPreviews;let w=window.data.typeOfHouse,y=window.data.typeOfRoom,_=window.data.pinMainX,E=window.data.pinMainY;const h=document.querySelector(".ad-form"),g=document.querySelectorAll(".ad-form fieldset, .map__filters select, .map__filters fieldset"),S=document.querySelector(".map__pin--main"),L=document.querySelector(".ad-form__reset"),q=h.querySelector(".ad-form-header__input"),C=h.querySelector(".ad-form__input"),M=document.querySelector("#success"),k=document.querySelector("#error"),A=()=>{g.forEach((e=>{e.setAttribute("disabled","")}))},x=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},T=()=>{document.querySelectorAll("form").forEach((e=>{e.reset()})),A(),x(),h.classList.add("ad-form--disabled"),r.classList.add("map--faded"),S.style.left=_+"px",S.style.top=E+"px",O(!1),U.placeholder=l.flat;const e=document.querySelector(".map__card");S.addEventListener("click",Y),q.removeEventListener("change",m),C.removeEventListener("change",f),v(),e&&e.remove()};L.addEventListener("click",T);const N=()=>{const e=M.content.cloneNode(!0);document.addEventListener("click",P),document.addEventListener("keydown",b),i.appendChild(e),T()},P=e=>{e.preventDefault();const t=i.querySelector(".success");document.removeEventListener("click",P),document.removeEventListener("keydown",b),i.removeChild(t)},b=e=>{e.key===t&&P(e)},H=()=>{const e=k.content.cloneNode(!0),t=e.querySelector(".error__button");document.addEventListener("click",D),document.addEventListener("keydown",R),t.addEventListener("click",D),i.appendChild(e)},D=e=>{e.preventDefault();const t=i.querySelector(".error"),o=t.querySelector(".error__button");document.removeEventListener("click",D),document.removeEventListener("keydown",R),o.removeEventListener("click",D),i.removeChild(t)},R=e=>{e.key===t&&D(e)};h.addEventListener("submit",(e=>{e.preventDefault(),p(new FormData(h),N,H)}));const I=document.querySelector("#address");I.setAttribute("readonly","");const O=e=>{const t=S.offsetLeft,n=S.offsetTop;_&&E||(_=t,E=n);const a=S.clientHeight,r=S.clientWidth,i=Math.round(t+r/2),d=e?Math.round(n+a+o):Math.round(n+a/2);I.value=`${i}, ${d}`};O(!1);const V=()=>{g.forEach((e=>{e.removeAttribute("disabled","")})),h.classList.remove("ad-form--disabled"),r.classList.remove("map--faded"),O(!0),u(d,X),S.removeEventListener("click",Y),q.addEventListener("change",m),C.addEventListener("change",f)},X=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},Y=t=>{0!==t.button&&t.key!==e||(t.preventDefault(),V())},G=0,W=r.offsetWidth,$=130,F=630;document.querySelector("#title").addEventListener("input",(e=>{const t=e.target.value.length;e.target.validity.valueMissing?e.target.setCustomValidity("Обязательное поле"):t<n?e.target.setCustomValidity(`Ещё ${n-t} симв.`):t>a?e.target.setCustomValidity(`Удалите лишние ${t-a} симв.`):e.target.setCustomValidity(""),e.target.reportValidity()}));const U=document.querySelector("#price"),K=document.querySelector("#type"),j=e=>{const t=e.value;e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):t<l[w]?e.setCustomValidity("Минимальная цена "+l[w]):t>1e6?e.setCustomValidity("Максимальная цена 1000000"):e.setCustomValidity(""),e.reportValidity()};U.addEventListener("input",(e=>{j(e.target)})),K.addEventListener("change",(e=>{w=e.target.value,U.placeholder=l[e.target.value],j(U)}));const z=document.querySelector("#room_number"),B=document.querySelector("#capacity"),Q=e=>{const t=e.value;s[y].some((e=>e===t))?e.setCustomValidity(""):e.setCustomValidity(c[y]),e.reportValidity()};z.addEventListener("change",(e=>{y=e.target.value,Q(B)})),B.addEventListener("change",(e=>{Q(e.target)}));const Z=document.querySelector("#timein"),J=document.querySelector("#timeout");J.addEventListener("change",(()=>{Z.value=J.value})),Z.addEventListener("change",(()=>{J.value=Z.value}));const ee=document.querySelector("#avatar"),te=document.querySelector("#images");ee.setAttribute("accept","image/*"),te.setAttribute("accept","image/*"),window.notice={adForm:h,mapPinMain:S,setCoordinates:O,onMapPinMainClick:Y,onMapPinMainMouseDown:e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY},n=!1;const a=e=>{e.preventDefault(),n=!0;let a=t.x-e.clientX,r=t.y-e.clientY;t={x:e.clientX,y:e.clientY},S.style.top=S.offsetTop-r+"px",S.style.left=S.offsetLeft-a+"px",S.offsetLeft<G-Math.round(S.offsetWidth/2)?S.style.left=G-Math.round(S.offsetWidth/2)+"px":S.offsetLeft>W-Math.round(S.offsetWidth/2)&&(S.style.left=W-Math.round(S.offsetWidth/2)+"px"),S.offsetTop<$-S.offsetHeight-o?S.style.top=$-S.offsetHeight-o+"px":S.offsetTop>F-S.offsetHeight-o&&(S.style.top=F-S.offsetHeight-o+"px")},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",r),O(!0);const t=e=>{e.preventDefault(),S.removeEventListener("click",t)};n&&S.addEventListener("click",t)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",r)},disableElements:A,inputAddress:I,activatePage:V,removePins:x}})(),(()=>{const e=window.data.MAX_PINS,t=document.querySelector(".map__filters"),o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),a=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),i=window.pin.renderFragmentMapPins,d=window.helpers.debounce(i),s=window.notice.removePins,c=window.pin.removeCard,l={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};t.addEventListener("change",(()=>{s(),c();const e=window.hotels;d(u(e))}));const u=t=>(t=>{const o=t.slice(0,e);return window.sortedHotels=o,o})(t.filter((e=>{return t=e,("any"===o.value||t.offer.type===o.value)&(e=>"any"===n.value||e.offer.price>=l[n.value].min&&e.offer.price<=l[n.value].max)(e)&(e=>{let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.offer.features.indexOf(t.value)>=0))})(e)&(e=>"any"===a.value||e.offer.rooms.toString()===a.value)(e)&(e=>"any"===r.value||e.offer.guests.toString()===r.value)(e);var t})))})(),(()=>{const e=window.notice.mapPinMain,t=window.notice.onMapPinMainClick,o=window.notice.onMapPinMainMouseDown,n=window.notice.disableElements;e.addEventListener("click",t),e.addEventListener("mousedown",o),n()})()})();